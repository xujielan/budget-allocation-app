<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessible Budget Allocation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Styling for the budget blocks */
        .budget-block {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: grab;
            user-select: none;
        }

        .budget-block:focus {
            outline: 3px solid #005A9C; /* WCAG compliant focus indicator */
            outline-offset: 2px;
            box-shadow: 0 0 10px rgba(0, 90, 156, 0.5);
        }

        /* State for a block being dragged */
        .dragging {
            opacity: 0.5;
            transform: scale(0.9);
            cursor: grabbing;
        }
        
        /* State for a block that has been picked up via keyboard */
        .picked-up {
            outline: 3px solid #005A9C;
            outline-offset: 2px;
            box-shadow: 0 0 10px rgba(0, 90, 156, 0.5);
            transform: scale(1.05);
        }

        /* Highlight potential drop zones */
        .drag-over {
            background-color: #e0f2fe; /* Light blue highlight */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col items-center justify-center min-h-screen p-4 lg:p-8">

    <div class="w-full max-w-screen-2xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">City Services Budget Allocation Mock-up</h1>
            <p class="text-slate-600 mt-2 text-base md:text-lg">Drag and drop budget blocks to reallocate funds between services. Each block = $50 million.</p>
        </header>

        <!-- Main container for all service panels -->
        <main id="services-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4"></main>

        <!-- Live region for screen reader announcements -->
        <div id="sr-announcement" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    </div>

    <script>
        // --- DATA and CONFIGURATION ---
        const BLOCK_VALUE = 50000000; // Each block represents $50 million
        const servicesData = [
            { id: 'ttc', name: 'TTC & WheelTrans', blocks: 28, color: 'bg-red-600' },
            { id: 'police', name: 'Police', blocks: 26, color: 'bg-blue-600' },
            { id: 'housing', name: 'Affordable Housing & Shelters', blocks: 16, color: 'bg-amber-600' },
            { id: 'fire', name: 'Fire Services', blocks: 11, color: 'bg-purple-700' },
            { id: 'parks', name: 'Parks & Recreation', blocks: 8, color: 'bg-green-700' },
            { id: 'roads', name: 'Roads, bike lanes & sidewalks', blocks: 6, color: 'bg-slate-600' },
            { id: 'libraries', name: 'Libraries', blocks: 5, color: 'bg-indigo-700' },
            { id: 'paramedics', name: 'Paramedics', blocks: 3, color: 'bg-pink-700' },
        ];

        // --- GLOBAL STATE ---
        let draggedBlock = null; // For mouse drag-and-drop
        let pickedUpBlock = null; // For keyboard interaction
        let originalPanelId = null;

        // --- DOM ELEMENTS ---
        const servicesContainer = document.getElementById('services-container');
        const srAnnouncer = document.getElementById('sr-announcement');

        // --- UTILITY FUNCTIONS ---
        /**
         * Formats a large number into a readable currency string (e.g., $1.20 billion).
         * @param {number} value The number to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(value) {
            if (value >= 1_000_000_000) {
                return `$${(value / 1_000_000_000).toFixed(2)} billion`;
            }
            if (value >= 1_000_000) {
                return `$${(value / 1_000_000)} million`;
            }
            return `$${value.toLocaleString()}`;
        }

        // --- CORE LOGIC ---
        /**
         * Recalculates and updates the budget and percentage for all service panels.
         */
        function updateAllPanels() {
            const allBlocks = document.querySelectorAll('.budget-block');
            const totalBlocks = allBlocks.length;

            servicesData.forEach(service => {
                const panel = document.getElementById(`panel-${service.id}`);
                if (!panel) return;

                const blockContainer = panel.querySelector('.block-container');
                const budgetDisplay = panel.querySelector('.budget-display');
                const percentageDisplay = panel.querySelector('.percentage-display');

                const currentBlocksCount = blockContainer.children.length;
                const currentBudget = currentBlocksCount * BLOCK_VALUE;
                const currentPercentage = totalBlocks > 0 ? (currentBlocksCount / totalBlocks) * 100 : 0;

                budgetDisplay.textContent = formatCurrency(currentBudget);
                percentageDisplay.textContent = `${Math.round(currentPercentage)}%`;
            });
        }
        
        /**
         * Announces changes to screen readers.
         * @param {string} message The message to announce.
         */
        function announce(message) {
            srAnnouncer.textContent = message;
            // Clear after a moment to allow repeated announcements of the same text
            setTimeout(() => { srAnnouncer.textContent = ''; }, 500);
        }

        // --- EVENT HANDLERS (DRAG & DROP) ---
        function handleDragStart(e) {
            draggedBlock = e.target;
            originalPanelId = e.target.closest('.service-panel').id;
            // Add a slight delay to allow the browser to render the drag image
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedBlock = null;
            originalPanelId = null;
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            const dropZone = e.target.closest('.block-container');
            if (dropZone && dropZone !== draggedBlock.parentElement) {
                 dropZone.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const dropZone = e.target.closest('.block-container');
             if (dropZone) {
                dropZone.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.block-container');
            if (dropZone && draggedBlock) {
                dropZone.classList.remove('drag-over');
                const targetPanel = dropZone.closest('.service-panel');

                // Only move if it's a new panel
                if (targetPanel.id !== originalPanelId) {
                    dropZone.appendChild(draggedBlock);
                    updateAllPanels();
                    
                    const sourcePanelName = document.querySelector(`#${originalPanelId} h2`).textContent;
                    const targetPanelName = targetPanel.querySelector('h2').textContent;
                    announce(`Moved a $50 million block from ${sourcePanelName} to ${targetPanelName}.`);
                }
            }
        }
        
        // --- EVENT HANDLERS (KEYBOARD ACCESSIBILITY) ---
        function handleBlockKeyDown(e) {
            // Handle picking up a block
            if (e.key === 'Enter' && !pickedUpBlock) {
                e.preventDefault();
                pickedUpBlock = e.target;
                originalPanelId = pickedUpBlock.closest('.service-panel').id;
                pickedUpBlock.classList.add('picked-up');
                const panelName = document.querySelector(`#${originalPanelId} h2`).textContent;
                announce(`Picked up a $50 million block from ${panelName}. Use Tab to select a new service panel and press Enter to drop.`);
            } 
            // Handle dropping a block
            else if (e.key === 'Enter' && pickedUpBlock) {
                 e.preventDefault();
                 // This case is handled by the panel keydown listener.
            }
            // Handle cancelling the action
            else if (e.key === 'Escape' && pickedUpBlock) {
                e.preventDefault();
                pickedUpBlock.classList.remove('picked-up');
                announce(`Cancelled moving block. It remains in ${document.querySelector(`#${originalPanelId} h2`).textContent}.`);
                pickedUpBlock = null;
                originalPanelId = null;
            }
        }

        function handlePanelKeyDown(e) {
            if (e.key === 'Enter' && pickedUpBlock) {
                e.preventDefault();
                const targetPanel = e.currentTarget;
                const dropZone = targetPanel.querySelector('.block-container');

                if (targetPanel.id !== originalPanelId) {
                    dropZone.appendChild(pickedUpBlock);
                    updateAllPanels();
                    const sourcePanelName = document.querySelector(`#${originalPanelId} h2`).textContent;
                    const targetPanelName = targetPanel.querySelector('h2').textContent;
                    announce(`Dropped a $50 million block in ${targetPanelName}.`);
                } else {
                    announce(`Block returned to ${targetPanelName}.`);
                }

                pickedUpBlock.classList.remove('picked-up');
                pickedUpBlock.focus(); // Return focus to the block
                pickedUpBlock = null;
                originalPanelId = null;
            }
        }


        // --- INITIALIZATION ---
        /**
         * Creates and initializes the application UI.
         */
        function initialize() {
            servicesData.forEach(service => {
                // Create the main panel container
                const panel = document.createElement('div');
                panel.id = `panel-${service.id}`;
                panel.className = 'service-panel bg-slate-100 border border-slate-300 rounded-lg p-3 flex flex-col h-full min-h-[400px]';
                panel.setAttribute('tabindex', '0'); // Make panel focusable for keyboard drop
                panel.setAttribute('aria-label', `${service.name}. Press Enter to drop a selected budget block here.`);

                // Create and append child elements
                panel.innerHTML = `
                    <h2 class="font-bold text-center text-sm md:text-base ${service.color.replace('bg-', 'text-')} h-14 flex items-center justify-center">${service.name}</h2>
                    <p class="budget-display text-xl md:text-2xl font-bold text-center my-2 text-slate-800" aria-live="polite"></p>
                    <div class="block-container flex-grow flex flex-wrap-reverse content-start justify-start gap-1 p-1 mx-auto" style="max-width: 4.25rem;">
                        <!-- Blocks will be generated here -->
                    </div>
                    <p class="percentage-display text-lg md:text-xl font-bold text-center mt-2 text-slate-700" aria-live="polite"></p>
                `;

                const blockContainer = panel.querySelector('.block-container');

                // Generate budget blocks
                for (let i = 0; i < service.blocks; i++) {
                    const block = document.createElement('div');
                    block.className = `budget-block w-7 h-4 rounded-sm ${service.color} text-white flex items-center justify-center`;
                    block.draggable = true;
                    block.setAttribute('tabindex', '0');
                    block.setAttribute('role', 'button');
                    block.setAttribute('aria-label', `Budget block, $50 million, from ${service.name}. Press Enter to pick up.`);
                    
                    // Add event listeners for each block
                    block.addEventListener('dragstart', handleDragStart);
                    block.addEventListener('dragend', handleDragEnd);
                    block.addEventListener('keydown', handleBlockKeyDown);

                    blockContainer.appendChild(block);
                }

                // Add event listeners for the panel (drop zone)
                panel.addEventListener('keydown', handlePanelKeyDown);
                const dropZone = panel.querySelector('.block-container');
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);

                servicesContainer.appendChild(panel);
            });

            updateAllPanels();
        }

        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>



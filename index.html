<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessible Budget Allocation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library for taking screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Styling for the budget blocks */
        .budget-block {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: grab;
            user-select: none;
        }

        .budget-block:focus {
            outline: 3px solid #005A9C; /* WCAG compliant focus indicator */
            outline-offset: 2px;
            box-shadow: 0 0 10px rgba(0, 90, 156, 0.5);
        }

        /* State for a block being dragged */
        .dragging {
            opacity: 0.5;
            transform: scale(0.9);
            cursor: grabbing;
        }
        
        /* State for a block that has been picked up via keyboard */
        .picked-up {
            outline: 3px solid #005A9C;
            outline-offset: 2px;
            box-shadow: 0 0 10px rgba(0, 90, 156, 0.5);
            transform: scale(1.05);
        }

        /* Highlight potential drop zones */
        .drag-over {
            background-color: #e0f2fe; /* Light blue highlight */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col items-center justify-center min-h-screen p-4 lg:p-8">

    <!-- Reset and Refresh Button -->
    <div class="fixed top-6 left-6 z-50">
        <button id="reset-btn"
            class="bg-white px-4 py-2 rounded-full shadow-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 flex items-center space-x-2"
            aria-label="Reset budget allocations">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path>
            </svg>
            <span class="font-medium text-slate-700">Reset</span>
        </button>
    </div>

    <!-- Screenshot Button -->
    <div class="fixed top-6 right-6 z-50">
        <button id="screenshot-btn"
            class="bg-white px-4 py-2 rounded-full shadow-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 flex items-center space-x-2"
            aria-label="Save screenshot of budget allocation">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
             <span class="font-medium text-slate-700">Save</span>
        </button>
    </div>

    <!-- Main content area for screenshot -->
    <div class="w-full max-w-screen-2xl mx-auto" id="capture-area">
        <header class="text-center mb-6 pt-16">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">City Services Budget Allocation Mock-up</h1>
            <p class="text-slate-600 mt-2 text-base md:text-lg">Drag and drop budget blocks to reallocate funds between services. Each block = $50 million.</p>
        </header>

        <!-- Main container for all service panels -->
        <main id="services-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4"></main>

        <!-- Live region for screen reader announcements -->
        <div id="sr-announcement" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    </div>

    <script>
        // --- DATA and CONFIGURATION ---
        const BLOCK_VALUE = 50000000; // Each block represents $50 million
        const servicesData = [
            { id: 'ttc', name: 'TTC & WheelTrans', blocks: 28, color: 'bg-red-600' },
            { id: 'police', name: 'Police', blocks: 26, color: 'bg-blue-600' },
            { id: 'housing', name: 'Affordable Housing & Shelters', blocks: 16, color: 'bg-amber-600' },
            { id: 'fire', name: 'Fire Services', blocks: 11, color: 'bg-purple-700' },
            { id: 'parks', name: 'Parks & Recreation', blocks: 8, color: 'bg-emerald-600' },
            { id: 'roads', name: 'Roads, bike lanes, sidewalks', blocks: 6, color: 'bg-stone-600' },
            { id: 'libraries', name: 'Libraries', blocks: 5, color: 'bg-indigo-700' },
            { id: 'paramedics', name: 'Paramedics', blocks: 3, color: 'bg-pink-600' },
        ];

        // --- GLOBAL STATE ---
        let draggedBlock = null; // For mouse drag-and-drop
        let pickedUpBlock = null; // For keyboard interaction
        let originalPanelId = null;

        // --- DOM ELEMENTS ---
        const servicesContainer = document.getElementById('services-container');
        const srAnnouncer = document.getElementById('sr-announcement');

        // --- UTILITY FUNCTIONS ---
        /**
         * Formats a large number into a readable currency string (e.g., $1.20 billion).
         * @param {number} value The number to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(value) {
            if (value >= 1_000_000_000) {
                return `$${(value / 1_000_000_000).toFixed(2)} billion`;
            }
            if (value >= 1_000_000) {
                return `$${(value / 1_000_000)} million`;
            }
            return `$${value.toLocaleString()}`;
        }

        // --- CORE LOGIC ---
        /**
         * Recalculates and updates the budget and percentage for all service panels.
         */
        function updateAllPanels() {
            const allBlocks = document.querySelectorAll('.budget-block');
            const totalBlocks = allBlocks.length;

            servicesData.forEach(service => {
                const panel = document.getElementById(`panel-${service.id}`);
                if (!panel) return;

                const blockContainer = panel.querySelector('.block-container');
                const budgetDisplay = panel.querySelector('.budget-display');
                const percentageDisplay = panel.querySelector('.percentage-display');

                const currentBlocksCount = blockContainer.children.length;
                const currentBudget = currentBlocksCount * BLOCK_VALUE;
                const currentPercentage = totalBlocks > 0 ? (currentBlocksCount / totalBlocks) * 100 : 0;

                budgetDisplay.textContent = formatCurrency(currentBudget);
                percentageDisplay.textContent = `${Math.round(currentPercentage)}%`;
            });
        }
        
        /**
         * Announces changes to screen readers.
         * @param {string} message The message to announce.
         */
        function announce(message) {
            srAnnouncer.textContent = message;
            // Clear after a moment to allow repeated announcements of the same text
            setTimeout(() => { srAnnouncer.textContent = ''; }, 500);
        }

        // --- EVENT HANDLERS (DRAG & DROP) ---
        function handleDragStart(e) {
            draggedBlock = e.target;
            originalPanelId = e.target.closest('.service-panel').id;
            // Add a slight delay to allow the browser to render the drag image
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedBlock = null;
            originalPanelId = null;
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            const dropZone = e.target.closest('.block-container');
            if (draggedBlock && dropZone && dropZone !== draggedBlock.parentElement) {
                 dropZone.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const dropZone = e.target.closest('.block-container');
             if (dropZone) {
                dropZone.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.block-container');
            if (dropZone && draggedBlock) {
                dropZone.classList.remove('drag-over');
                const targetPanel = dropZone.closest('.service-panel');

                // Only move if it's a new panel
                if (targetPanel.id !== originalPanelId) {
                    dropZone.appendChild(draggedBlock);
                    updateAllPanels();
                    
                    const sourcePanelName = document.querySelector(`#${originalPanelId} h2`).textContent;
                    const targetPanelName = targetPanel.querySelector('h2').textContent;
                    announce(`Moved a $50 million block from ${sourcePanelName} to ${targetPanelName}.`);
                }
            }
        }
        
        // --- EVENT HANDLERS (KEYBOARD ACCESSIBILITY) ---
        function handleBlockKeyDown(e) {
            if (e.key === 'Enter' && !pickedUpBlock) {
                e.preventDefault();
                pickedUpBlock = e.target;
                originalPanelId = pickedUpBlock.closest('.service-panel').id;
                pickedUpBlock.classList.add('picked-up');
                const panelName = document.querySelector(`#${originalPanelId} h2`).textContent;
                announce(`Picked up a $50 million block from ${panelName}. Use Tab to select a new service panel and press Enter to drop.`);
            } 
            else if (e.key === 'Enter' && pickedUpBlock) {
                 e.preventDefault();
                 // This case is handled by the panel keydown listener.
            }
            else if (e.key === 'Escape' && pickedUpBlock) {
                e.preventDefault();
                pickedUpBlock.classList.remove('picked-up');
                announce(`Cancelled moving block. It remains in ${document.querySelector(`#${originalPanelId} h2`).textContent}.`);
                pickedUpBlock = null;
                originalPanelId = null;
            }
        }

        function handlePanelKeyDown(e) {
            if (e.key === 'Enter' && pickedUpBlock) {
                e.preventDefault();
                const targetPanel = e.currentTarget;
                const targetPanelName = targetPanel.querySelector('h2').textContent;
                const dropZone = targetPanel.querySelector('.block-container');

                if (targetPanel.id !== originalPanelId) {
                    dropZone.appendChild(pickedUpBlock);
                    updateAllPanels();
                    announce(`Dropped a $50 million block in ${targetPanelName}.`);
                } else {
                    announce(`Block returned to ${targetPanelName}.`);
                }

                pickedUpBlock.classList.remove('picked-up');
                pickedUpBlock.focus(); // Return focus to the block
                pickedUpBlock = null;
                originalPanelId = null;
            }
        }

        // --- INITIALIZATION ---
        function initialize() {
            servicesData.forEach(service => {
                const panel = document.createElement('div');
                panel.id = `panel-${service.id}`;
                panel.className = 'service-panel bg-slate-100 border border-slate-300 rounded-lg p-3 flex flex-col h-full min-h-[400px]';
                panel.setAttribute('tabindex', '0');
                panel.setAttribute('aria-label', `${service.name}. Press Enter to drop a selected budget block here.`);

                panel.innerHTML = `
                    <h2 class="font-bold text-center text-sm md:text-base ${service.color.replace('bg-', 'text-')} h-14 flex items-center justify-center">${service.name}</h2>
                    <p class="budget-display text-xl md:text-2xl font-bold text-center my-2 text-slate-800" aria-live="polite"></p>
                    <div class="block-container flex-grow flex flex-wrap-reverse content-start justify-start gap-1 p-1 mx-auto" style="max-width: 4.25rem;">
                    </div>
                    <p class="percentage-display text-lg md:text-xl font-bold text-center mt-2 text-slate-700" aria-live="polite"></p>
                `;

                const blockContainer = panel.querySelector('.block-container');
                for (let i = 0; i < service.blocks; i++) {
                    const block = document.createElement('div');
                    block.className = `budget-block w-7 h-4 rounded-sm ${service.color} text-white flex items-center justify-center`;
                    block.draggable = true;
                    block.setAttribute('tabindex', '0');
                    block.setAttribute('role', 'button');
                    block.setAttribute('aria-label', `Budget block, $50 million, from ${service.name}. Press Enter to pick up.`);
                    
                    block.addEventListener('dragstart', handleDragStart);
                    block.addEventListener('dragend', handleDragEnd);
                    block.addEventListener('keydown', handleBlockKeyDown);

                    blockContainer.appendChild(block);
                }

                panel.addEventListener('keydown', handlePanelKeyDown);
                const dropZone = panel.querySelector('.block-container');
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);

                servicesContainer.appendChild(panel);
            });

            updateAllPanels();
        }

        // --- NEW BUTTONS LOGIC ---
        function setupActionButtons() {
            const resetButton = document.getElementById('reset-btn');
            const screenshotButton = document.getElementById('screenshot-btn');

            resetButton.addEventListener('click', () => {
                announce('Page reset.');
                location.reload();
            });

            screenshotButton.addEventListener('click', () => {
                const captureArea = document.getElementById('capture-area');
                
                resetButton.style.visibility = 'hidden';
                screenshotButton.style.visibility = 'hidden';
                
                announce('Taking screenshot.');

                html2canvas(captureArea, {
                    backgroundColor: '#f8fafc', // Corresponds to Tailwind's bg-slate-50
                    useCORS: true,
                }).then(canvas => {
                    const imageURL = canvas.toDataURL('image/png');
                    const downloadLink = document.createElement('a');
                    downloadLink.href = imageURL;
                    downloadLink.download = 'budget-allocation-screenshot.png';
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    resetButton.style.visibility = 'visible';
                    screenshotButton.style.visibility = 'visible';
                    announce('Screenshot saved.');

                }).catch(err => {
                    console.error("Screenshot failed:", err);
                    announce('Error taking screenshot.');
                    resetButton.style.visibility = 'visible';
                    screenshotButton.style.visibility = 'visible';
                });
            });
        }
        
        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            setupActionButtons();
        });
    </script>
</body>
</html>

